{{#section 'css'}}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
    /* --- General Styles --- */
    body {
        background-color: #fff;
        color: #212529;
        font-family: 'Inter', sans-serif;
    }

    /* Avatar Badge */
    .avatar-badge {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
    }

    .avatar-seller {
        background-color: #fd7e14;
    }

    /* Cam cho seller */
    .avatar-bidder {
        background-color: #e9ecef;
        color: #333;
    }

    /* X√°m cho bidder */

    /* Product Images */
    .main-image-container {
        background-color: #e9ecef;
        border-radius: 12px;
        height: 450px;
        position: relative;
        overflow: hidden;
    }

    .main-image-container img {
        object-fit: contain;
        width: 100%;
        height: 100%;
    }

    .thumb-img {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        background-color: #e9ecef;
        cursor: pointer;
        object-fit: cover;
        border: 2px solid transparent;
    }

    .thumb-img.active {
        border-color: #0d6efd;
    }

    /* Buttons */
    .btn-action-primary {
        background-color: #0d6efd;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        padding: 10px 0;
        width: 100%;
        color: white;
        transition: 0.2s;
    }

    .btn-action-primary:hover {
        background-color: #0b5ed7;
    }

    .btn-action-outline {
        background-color: transparent;
        border: 2px solid #0d6efd;
        border-radius: 50px;
        font-weight: 600;
        padding: 10px 0;
        width: 100%;
        color: #0d6efd;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .btn-action-outline:hover {
        background-color: #0d6efd;
        /* N·ªÅn xanh d∆∞∆°ng ƒë·∫≠m */
        color: white;
    }

    /* Bid History Table */
    .bid-table th {
        font-weight: 600;
        border-bottom: 2px solid #f1f1f1;
    }

    .btn-kick {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 4px;
        border: 1px solid #dc3545;
        color: #dc3545;
        background: #fff;
    }

    .btn-kick:hover {
        background: #dc3545;
        color: #fff;
    }

    /* Description Card */
    .desc-card {
        background-color: #f1f3f5;
        /* M√†u x√°m nh∆∞ design */
        border-radius: 12px;
        padding: 30px;
        border: none;
    }

    .btn-edit-desc {
        background: white;
        border: 1px solid #ced4da;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #495057;
        cursor: pointer;
    }

    /* Facebook Style Comments */
    .comment-bubble {
        background-color: #f0f2f5;
        border-radius: 18px;
        padding: 10px 15px;
        display: inline-block;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .reply-link {
        font-size: 0.8rem;
        font-weight: 600;
        color: #65676b;
        text-decoration: none;
        cursor: pointer;
    }

    /* Related Products (Owl Carousel) */
    .related-card {
        background: #f8f9fa;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .related-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .related-img {
        height: 180px;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .related-img a {
        display: block;
        width: 100%;
        height: 100%;
    }

    .related-img img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .wishlist-btn-small {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        z-index: 2;
    }

    .text-gold {
        color: #ffc107 !important;
    }

    /* Clickable points badge */
    .points-clickable {
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-block;
    }

    .points-clickable:hover {
        background-color: #e9ecef;
        color: #0d6efd !important;
    }

    /* Rating Modal Styles */
    .rating-modal-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .rating-modal-stat {
        flex: 1;
        text-align: center;
        padding: 15px;
        border-radius: 12px;
        background: #f8f9fa;
    }

    .rating-modal-stat.positive {
        background: #d1e7dd;
        color: #0f5132;
    }

    .rating-modal-stat.negative {
        background: #f8d7da;
        color: #842029;
    }

    .rating-modal-stat .stat-number {
        font-size: 1.8rem;
        font-weight: 800;
        line-height: 1;
    }

    .rating-modal-stat .stat-label {
        font-size: 0.8rem;
        margin-top: 5px;
    }

    .rating-list-item {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .rating-list-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .rating-avatar-small {
        width: 42px;
        height: 42px;
        min-width: 42px;
        background: #fd7e14;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 700;
        color: white;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .rating-content-small {
        flex: 1;
        min-width: 0;
        padding-right: 15px;
    }

    .rating-badge-small {
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1rem;
        white-space: nowrap;
        flex-shrink: 0;
        align-self: center;
    }

    .badge-pos {
        background: #198754;
        color: white;
    }

    .badge-neg {
        background: #dc3545;
        color: white;
    }

    /* SweetAlert Rating Popup Custom Styles */
    .swal2-popup.rating-popup {
        font-size: 1rem !important;
    }

    .swal2-popup.rating-popup .swal2-title {
        font-size: 1.4rem !important;
    }
</style>
{{/section}}

<div class="container-fluid px-4">
    <a href="javascript:history.back()" class="btn btn-primary rounded-pill px-4 mb-4 fw-bold">
        <i class="bi bi-arrow-left me-1"></i> Back
    </a>

    <div class="row g-5">
        <div class="col-lg-6">
            <div class="main-image-container d-flex justify-content-center align-items-center mb-4 position-relative">
                <img id="mainImage" src="/src/static/images/{{product.seller_id}}/{{product.product_id}}/main.jpg"
                    alt="{{product.name}}" data-index="0">
            </div>

            <div class="d-flex gap-3 justify-content-center" id="thumbnailList">

                <img src="/src/static/images/{{product.seller_id}}/{{product.product_id}}/main_thumbs.jpg"
                    class="thumb-img active" data-index="0" data-filename="main.jpg">

                <img src="/src/static/images/{{product.seller_id}}/{{product.product_id}}/1_thumbs.jpg"
                    class="thumb-img" data-index="1" data-filename="1.jpg" onerror="this.style.display='none'"> <img
                    src="/src/static/images/{{product.seller_id}}/{{product.product_id}}/2_thumbs.jpg" class="thumb-img"
                    data-index="2" data-filename="2.jpg" onerror="this.style.display='none'">

                <img src="/src/static/images/{{product.seller_id}}/{{product.product_id}}/3_thumbs.jpg"
                    class="thumb-img" data-index="3" data-filename="3.jpg" onerror="this.style.display='none'">
            </div>
        </div>

        <div class="col-lg-6">
            <h1 class="serif-font fw-bold mb-3">{{product.name}}</h1>

            <div class="d-flex align-items-center mb-4">
                <div class="avatar-badge avatar-seller me-3">
                    {{substr seller.seller_name 0 1}}
                </div>
                <div>
                    <div class="fw-bold fs-5">{{seller.seller_name}}</div>
                    <div class="text-muted small">Points: {{seller.seller_point}} / {{seller.positive_point}}</div>
                </div>
            </div>

            <div class="mb-2">
                <span class="fw-bold fs-5">{{#if product.current_price}}Highest bid:{{else}}Starting price:{{/if}}</span>
                <span class="fw-bold fs-4 text-warning">
                    {{#if product.current_price}}
                    {{formatCurrency product.current_price}}
                    {{else}}
                    {{formatCurrency product.start_price}}
                    {{/if}}
                </span>
            </div>

            {{#if bidder}}
            <div class="d-flex align-items-center mb-4 p-2 bg-light rounded-3" style="width: fit-content;">
                <div class="avatar-badge avatar-bidder me-2" style="width:32px; height:32px; font-size:0.9rem;">
                    {{substr winBidder.full_name 0 1}}
                </div>
                <div>
                    <div class="fw-bold" style="line-height: 1.2;">{{maskName winBidder.full_name}}</div>
                    <div class="text-muted small">Points: {{winBidder.points}} / {{winBidder.positive_point}}</div>
                </div>
            </div>
            {{else}}
            <div class="text-muted mb-4 fst-italic">No bids yet.</div>
            {{/if}}

            <div class="text-muted small mb-4 lh-lg">
                <div>Listed: <strong>{{formatDate product.created_at "DD/MM/YYYY"}}</strong></div>
                <div>Time left: <strong>{{formatAuctionTime product.end_time "DD/MM/YYYY"}}</strong></div>
                <div>Bids: <strong>{{product.bid_count}}</strong></div>
                <div class="fs-5 mt-2 text-dark">
                    Buy it now:
                    {{#if product.buy_now_price}}
                    <span class="fw-bold text-primary">{{formatCurrency product.buy_now_price}}</span>
                    {{else}}
                    <span class="text-muted">Not available</span>
                    {{/if}}
                </div>
            </div>

            {{#if isAuthenticated}}

            {{!-- LOGIC: Check xem user ƒëang ƒëƒÉng nh·∫≠p C√ì PH·∫¢I l√† ch·ªß s·∫£n ph·∫©m kh√¥ng --}}
            {{#if (eq authUser.user_id product.seller_id)}}

            <div class="alert alert-info border-info">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-person-check-fill fs-4"></i>
                    <div>
                        <strong>You are the owner of this product.</strong><br>
                        You can manage descriptions and view detailed bid history.
                    </div>
                </div>
            </div>

            {{else}}

            {{#if (eq product.status 'active')}}
            {{!-- Form Place Bid (ƒê√£ chuy·ªÉn t·ª´ d∆∞·ªõi l√™n) --}}
            <form method="POST" action="/menu/place-bid" id="bidForm" class="mb-4">
                <input type="hidden" name="product_id" value="{{product.product_id}}">
                <input type="hidden" name="bidder_id" value="{{authUser.user_id}}">
                
                {{!-- Hidden Input cho gi√° min ƒë·ªÉ JS check --}}
                <input type="hidden" id="minBid" value="{{#if product.current_price}}{{suggestedPrice}}{{else}}{{product.start_price}}{{/if}}">

                <label for="bidAmount" class="form-label fw-bold">Place your bid:</label>
                
                <div class="input-group">
                    <span class="input-group-text fw-bold">$</span>
                    <input type="text" class="form-control currency-input" id="bidAmount" name="max_auto_bid" placeholder="Amount" required>
                    <button type="submit" class="btn btn-primary fw-bold px-4" id="submitBidBtn">
                        Bid
                    </button>
                </div>

                {{!-- D√≤ng th√¥ng b√°o nh·ªè b√™n d∆∞·ªõi input --}}
                <div class="form-text mt-2">
                    {{#if product.current_price}}
                        Min bid: <strong>{{formatCurrency suggestedPrice}}</strong>
                        <span class="text-muted">(Step: {{formatCurrency product.bid_step}})</span>
                        {{#if (eq authUser.user_id product.leader_id)}}
                            <div class="text-success fw-bold mt-1"><i class="bi bi-check-circle-fill"></i> You are leading!</div>
                        {{/if}}
                    {{else}}
                        Starting price: <strong>{{formatCurrency product.start_price}}</strong>
                    {{/if}}
                </div>
            </form>

            {{#if product.buy_now_price}}
            <form method="POST" action="/menu/buy-now" id="buyNowForm">
                <input type="hidden" name="product_id" value="{{product.product_id}}">
                <input type="hidden" name="buy_now_price" id="buyNowPrice" value="{{product.buy_now_price}}">
                <button type="submit" class="btn-action-outline" id="buyNowBtn">
                    <i class="bi bi-lightning-fill me-1"></i> Buy it now - {{formatCurrency product.buy_now_price}}
                </button>
            </form>
            {{/if}}

            {{else}}
            <div class="alert alert-danger text-center fw-bold">
                <i class="bi bi-exclamation-circle-fill"></i> This auction has ended.
            </div>
            {{/if}}

            <button class="btn-action-outline wishlist-toggle" data-id="{{product.product_id}}">
                {{#if is_liked}}
                <i class="bi bi-heart-fill me-1"></i> Remove from watchlist
                {{else}}
                <i class="bi bi-heart me-1"></i> Add to watchlist
                {{/if}}
            </button>
            {{/if}}

            {{else}}
            <div class="alert alert-warning">
                Please <a href="/signin?retUrl=/menu/detail?product_id={{product.product_id}}" class="fw-bold">Sign in</a> to place a bid.
            </div>
            {{/if}}
        </div>
    </div>

    {{#if isAuthenticated}}
    
    <section class="mt-5">
        <div class="row g-4">
            <!-- Bidding History -->
                <div>
                    <h4 class="serif-font fw-bold">Bidding History</h4>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        {{#if bidder}}
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Time</th>
                                            <th>Bidder</th>
                                            <th class="text-center">Bid Amount</th>
                                            {{#if (eq authUser.user_id product.seller_id)}}
                                            <th class="text-center">Action</th>
                                            {{/if}}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each bidder}}
                                        <tr>
                                            {{!-- 1. C·ªôt Th·ªùi gian --}}
                                            <td class="align-middle">{{formatDate this.created_at 'DD/MM/YYYY HH:mm:ss'}}</td>
                                            
                                            {{!-- 2. C·ªôt T√™n Bidder (Masked Name) --}}
                                            <td class="align-middle">
                                                {{#if this.full_name}}
                                                    {{maskName this.full_name}}
                                                {{else}}
                                                    Anonymous
                                                {{/if}}
                                            </td>

                                            {{!-- 3. C·ªôt Gi√° ti·ªÅn (In ƒë·∫≠m, m√†u xanh) --}}
                                            <td class="text-center align-middle fw-bold text-success">
                                                {{formatCurrency this.bid_amount}}
                                            </td>

                                            {{!-- 4. C·ªôt Action (Ch·ªâ hi·ªán cho Seller) --}}
                                            {{#if (eq ../authUser.user_id ../product.seller_id)}}
                                            <td class="text-center align-middle">
                                                {{!-- QUAN TR·ªåNG: Gi·ªØ nguy√™n class reject-bidder-btn v√† c√°c data-attribute --}}
                                                <button class="btn btn-sm btn-outline-danger reject-bidder-btn" 
                                                        data-bidder-id="{{this.user_id}}"
                                                        data-bidder-name="{{this.full_name}}"
                                                        data-product-id="{{../product.product_id}}"
                                                        title="Reject this bidder">
                                                    <i class="bi bi-x-circle"></i> Kick
                                                </button>
                                            </td>
                                            {{/if}}
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        {{else}}
                            <p class="text-muted text-center py-4">
                                <i class="bi bi-inbox"></i><br>
                                No bids yet. Be the first to bid!
                            </p>
                        {{/if}}
                    </tr>
                </thead>
            </table>
        </div>
                </div>
    {{/if}}

    <div class="mt-5">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h4 class="serif-font fw-bold">Description</h4>

            {{#if isAuthenticated}}
            {{#if (eq authUser.user_id product.seller_id)}}
            <button class="btn btn-sm btn-outline-dark d-flex align-items-center gap-2" type="button"
                data-bs-toggle="collapse" data-bs-target="#editDescArea">
                <i class="bi bi-pencil-square"></i> Add Description
            </button>
            {{/if}}
            {{/if}}
        </div>

        {{#if isAuthenticated}}
        {{#if (eq authUser.user_id product.seller_id)}}
        <div class="collapse mb-4" id="editDescArea">
            <div class="card card-body border-0 shadow-sm bg-light">
                <h6 class="mb-2 fw-bold text-primary">Append new information:</h6>
                <form method="POST" action="/menu/append-description" id="frmAppendDesc">
                    <input type="hidden" name="product_id" value="{{product.product_id}}">
                    <input type="hidden" name="new_description_html" id="hiddenDescInput">

                    <div id="quill-editor" style="height: 150px; background: white;"></div>

                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-primary px-4">Save Update</button>
                    </div>
                </form>
            </div>
        </div>
        {{/if}}
        {{/if}}

        <div class="desc-card">
            <div class="mb-4">
                <h6 class="fw-bold">Original Description:</h6>
                {{{product.description_html}}}
            </div>

            {{#each description_logs}}
            <div class="mt-4 pt-3 border-top border-secondary">
                <h6 class="fw-bold small text-muted">Updated at {{formatDate this.created_at "DD/MM/YYYY HH:mm"}}:</h6>
                <div>{{{this.content_html}}}</div>
            </div>
            {{/each}}
        </div>
    </div>

    <div class="mt-5">
        <h4 class="serif-font fw-bold mb-4">Feedback</h4>

        <div class="d-flex flex-column gap-3" id="commentList">
            {{#each comments}}
            <div class="d-flex gap-2">
                <div class="flex-shrink-0">
                    {{#if (eq this.user_id ../authUser.user_id)}}
                    <div class="avatar-badge bg-primary" style="width:40px; height:40px; font-size:1rem;">Me</div>
                    {{else}}
                    <div class="avatar-badge bg-secondary" style="width:40px; height:40px; font-size:1rem;">
                        {{substr this.reviewer_name 0 1}}
                    </div>
                    {{/if}}
                </div>

                <div class="flex-grow-1">
                    <div class="comment-bubble">
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-bold" style="font-size: 0.9rem;">{{this.reviewer_name}}</span>
                            {{#if (eq this.user_id ../product.seller_id)}}
                            <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">
                                <i class="bi bi-shop"></i> Seller
                            </span>
                            {{/if}}
                        </div>
                        <div class="text-dark" style="font-size: 0.95rem;">
                            {{this.content}}
                        </div>
                    </div>

                    <div class="ms-2 mt-1 d-flex gap-3 align-items-center">
                        <span class="text-muted small">{{formatDate this.created_at "DD/MM/YYYY"}}</span>
                        {{#if ../isAuthenticated}}
                        <a href="javascript:;" class="reply-trigger fw-bold text-decoration-none small text-primary"
                            data-id="{{this.comment_id}}" data-name="{{this.reviewer_name}}">
                            Reply
                        </a>
                        {{/if}}
                    </div>

                    {{#if this.replies}}
                    <div class="mt-2">
                        {{#each this.replies}}
                        <div class="d-flex gap-2 ms-5 mt-2">
                            <div class="flex-shrink-0">
                                {{#if (eq this.user_id ../../authUser.user_id)}}
                                <div class="avatar-badge bg-primary" style="width:32px; height:32px; font-size:0.8rem;">
                                    Me</div>
                                {{else}}
                                <div class="avatar-badge bg-secondary"
                                    style="width:32px; height:32px; font-size:0.8rem;">
                                    {{substr this.reviewer_name 0 1}}
                                </div>
                                {{/if}}
                            </div>

                            <div class="flex-grow-1">
                                <div class="comment-bubble">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold" style="font-size: 0.9rem;">{{this.reviewer_name}}</span>

                                        {{!-- Check Seller cho comment con --}}
                                        {{#if (eq this.user_id ../../product.seller_id)}}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">
                                            <i class="bi bi-shop"></i> Seller
                                        </span>
                                        {{/if}}
                                    </div>
                                    <div class="text-dark" style="font-size: 0.95rem;">
                                        {{this.content}}
                                    </div>
                                </div>
                                <div class="ms-2 mt-1">
                                    <span class="text-muted small">{{formatDate this.created_at "DD/MM/YYYY"}}</span>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{#if ../isAuthenticated}}
                    <div class="mt-2 d-none reply-box" id="reply-box-{{this.comment_id}}">
                        <form class="frm-post-comment d-flex gap-2 align-items-center">
                            <input type="hidden" name="product_id" value="{{../product.product_id}}">
                            <input type="hidden" name="parent_comment_id" value="{{this.comment_id}}">

                            <div class="avatar-badge bg-primary" style="width:32px; height:32px; font-size:0.8rem;">Me
                            </div>
                            <input type="text" name="content"
                                class="form-control rounded-pill bg-light border-0 px-3 py-1 small"
                                placeholder="Reply to {{this.reviewer_name}}..." required>
                            <button type="submit" class="btn btn-sm btn-primary rounded-circle"
                                style="width: 32px; height: 32px;">
                                <i class="bi bi-send-fill" style="font-size: 0.8rem;"></i>
                            </button>
                        </form>
                    </div>
                    {{/if}}

                </div>
            </div>
            {{/each}}

            {{#unless comments}}
            <p class="text-muted fst-italic" id="no-feedback-msg">No feedback yet. Be the first to ask!</p>
            {{/unless}}
        </div>

        {{#if isAuthenticated}}
        <div class="mt-4 pt-3 border-top">
            <div class="d-flex gap-2">
                <div class="avatar-badge bg-primary" style="width:40px; height:40px; font-size:1rem;">Me</div>
                <form class="frm-post-comment flex-grow-1">
                    <input type="hidden" name="product_id" value="{{product.product_id}}">
                    <input type="hidden" name="parent_comment_id" value="">
                    <div class="input-group">
                        <input type="text" name="content" class="form-control rounded-pill bg-light border-0 px-3"
                            placeholder="Ask a question or leave a feedback..." required>
                        <button class="btn btn-primary rounded-pill px-4 ms-2" type="submit">Post</button>
                    </div>
                </form>
            </div>
        </div>
        {{/if}}
    </div>

    <div class="mt-5 mb-5">
        <h4 class="serif-font fw-bold mb-4">Related products</h4>

        <div class="owl-carousel owl-theme">
            {{#each related_products}}
            <div class="item">
                <div class="related-card h-100">
                    <button class="wishlist-btn-small wishlist-icon-small" data-id="{{this.product_id}}">
                        {{#if this.is_liked}}
                        <i class="bi bi-heart-fill text-gold"></i>
                        {{else}}
                        <i class="bi bi-heart"></i>
                        {{/if}}
                    </button>

                    <div class="related-img">
                        <a href="/menu/detail?product_id={{this.product_id}}" class="stretched-link">
                            <img src="/src/static/images/{{this.seller_id}}/{{this.product_id}}/main_thumbs.jpg"
                                alt="{{this.name}}">
                        </a>
                    </div>

                    <div class="p-3">
                        <div class="fw-bold text-truncate" title="{{this.name}}">{{this.name}}</div>
                        <div class="text-muted small mb-1">{{#if this.leader_name}}Bidder: {{maskName this.leader_name}}{{else}}No Bids{{/if}}</div>

                        <div class="fw-bold fs-5 text-warning mb-2">{{#if this.current_price}}{{formatCurrency this.current_price}}{{else}}{{formatCurrency this.start_price}}{{/if}}</div>

                        <div class="text-muted small" style="line-height: 1.6;">
                            <div>Buy it now: <span class="text-primary fw-bold">{{#if this.buy_now_price}}{{formatCurrency
                                    this.buy_now_price}}{{else}}None{{/if}}</span></div>
                            <div>Listed: {{formatDate this.created_at "DD/MM/YYYY"}}</div>
                            <div>Time left: {{formatAuctionTime this.end_time "DD/MM/YYYY"}}</div>
                            <div>Bids: {{this.bid_count}}</div>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </section>
</main>

<!-- SweetAlert2 Library -->
{{#section 'js'}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<script>
    // Bid form validation with SweetAlert
    {{#if isAuthenticated}}
        // Only attach bid form listener if form exists (user is not seller)
        const bidForm = document.getElementById('bidForm');
        if (bidForm) {
            bidForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                
                const rawValue = document.getElementById('bidAmount').value.replace(/,/g, '');
                const bidAmount = parseFloat(rawValue);
                const minBid = parseFloat(document.getElementById('minBid').value);
                const userMaxBid = parseFloat(document.getElementById('userMaxBid').value) || 0;
                const highestBid = {{#if product.current_price}}{{product.current_price}}{{else}}{{product.start_price}}{{/if}};
                const maxBid = {{#if product.leader_max}}{{product.leader_max}}{{else}}0{{/if}};

                const authUserId = {{authUser.user_id}};
                const leaderId = {{#if product.leader_id}}{{product.leader_id}}{{else}}0{{/if}};
                
                // Basic client-side validation first
                if (!bidAmount || isNaN(bidAmount)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Bid',
                        text: 'Please enter a valid bid amount.',
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                if (bidAmount < minBid) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Bid Too Low',
                        text: `Minimum bid is $${minBid.toLocaleString()}. Please enter a bid of at least $${minBid.toLocaleString()}.`,
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // Check if bid is lower than user's own previous max bid
                if (userMaxBid > 0 && bidAmount <= userMaxBid) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Bid Too Low',
                        html: `You cannot place a bid equal to or lower than your previous max bid.<br><br>Your previous max bid: <strong>$${userMaxBid.toLocaleString()}</strong><br>Please enter a bid higher than <strong>$${userMaxBid.toLocaleString()}</strong>.`,
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // Show confirmation dialog before placing bid
                Swal.fire({
                    title: 'Confirm Your Bid',
                    html: `Are you sure you want to place a bid of <strong>$${bidAmount.toLocaleString()}</strong>?<br><br><small class="text-muted">This action cannot be undone.</small>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, Place Bid',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading state
                        Swal.fire({
                            title: 'Processing your bid...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                
                        // Send bid request to backend
                        fetch('/menu/place-bid', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'Accept': 'application/json'
                            },
                            body: new URLSearchParams(new FormData(form))
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Check if auction ended due to bid >= buy_now_price
                                if (data.auctionEnded) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'üéâ Congratulations! You Won!',
                                        html: '<p>Your bid exceeded the Buy Now price.</p><p>You are the winner of this auction!</p>',
                                        confirmButtonColor: '#198754',
                                        confirmButtonText: 'View My Won Items'
                                    }).then(() => {
                                        window.location.href = data.redirectUrl || '/profile/wonitem';
                                    });
                                } else {
                                    // Normal successful bid
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Bid Placed Successfully!',
                                        text: data.message || 'Your bid has been submitted successfully.',
                                        confirmButtonColor: '#198754',
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                }
                            } else if (data.errorCode === 'NO_RATING_HISTORY') {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Rating Required',
                                    html: '<strong>This premium auction requires a rating history.</strong><br><br>To participate in this auction, you need to:<br>‚Ä¢ Participate in other auctions first<br>‚Ä¢ Receive ratings from sellers<br>‚Ä¢ Build your reputation on the platform',
                                    confirmButtonColor: '#ffc107',
                                    confirmButtonText: 'Understood'
                                });
                            } else if (data.errorCode === 'INSUFFICIENT_RATING') {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Rating Too Low',
                                    html: `<strong>This premium auction requires at least 80% positive rating.</strong><br><br>Your current rating: <span class="text-danger">${data.currentRating.toFixed(1)}%</span><br>Required rating: <span class="text-success">80%</span><br><br>Continue participating in auctions and providing excellent service to improve your rating!`,
                                    confirmButtonColor: '#ffc107',
                                    confirmButtonText: 'Understood'
                                });
                            } else {
                                // Generic error message
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Bidding Failed',
                                    text: data.message || 'An error occurred while placing your bid.',
                                    confirmButtonColor: '#dc3545',
                                    confirmButtonText: 'OK'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error placing bid:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: error.message || 'An error occurred while placing your bid. Please try again.',
                                confirmButtonColor: '#dc3545',
                                confirmButtonText: 'OK'
                            });
                        });
                    }
                });
            });
        }
        
        // Reject bidder functionality for seller - Always attach this
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('reject-bidder-btn') || e.target.closest('.reject-bidder-btn')) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Reject button clicked!'); // Debug log
                
                const btn = e.target.closest('.reject-bidder-btn');
                const bidderId = btn.dataset.bidderId;
                const bidderName = btn.dataset.bidderName;
                const productId = btn.dataset.productId;
                
                console.log('Bidder ID:', bidderId, 'Product ID:', productId); // Debug log
                
                Swal.fire({
                    title: 'Reject Bidder?',
                    text: `Are you sure you want to reject ${bidderName ? bidderName.charAt(0) + '***' : 'this bidder'} from bidding on this item? This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, reject',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log('Sending reject request...'); // Debug log
                        
                        // Send reject request
                        fetch('/menu/reject-bidder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                bidder_id: bidderId,
                                product_id: productId
                            })
                        })
                        .then(response => {
                            console.log('Response status:', response.status); // Debug log
                            return response.json();
                        })
                        .then(data => {
                            console.log('Response data:', data); // Debug log
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Bidder Rejected',
                                    text: 'The bidder has been successfully rejected and notified via email.',
                                    confirmButtonColor: '#198754'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to reject bidder.',
                                    confirmButtonColor: '#dc3545'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred. Please try again.',
                                confirmButtonColor: '#dc3545'
                            });
                        });
                    }
                });
            }
        });

        // Buy Now functionality
        const buyNowForm = document.getElementById('buyNowForm');
        if (buyNowForm) {
            buyNowForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const buyNowPrice = parseFloat(document.getElementById('buyNowPrice').value);
                
                // Show confirmation dialog
                Swal.fire({
                    title: '<i class="bi bi-lightning-fill text-warning"></i> Buy Now',
                    html: `
                        <p>Are you sure you want to buy this item immediately for:</p>
                        <h2 class="text-primary fw-bold">$${buyNowPrice.toLocaleString()}</h2>
                        <p class="text-muted small">This will end the auction immediately and you will be the winner.</p>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="bi bi-check-lg"></i> Yes, Buy Now',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading state
                        Swal.fire({
                            title: 'Processing your purchase...',
                            html: '<p>Please wait while we complete your transaction.</p>',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        
                        // Send buy now request
                        fetch('/menu/buy-now', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'Accept': 'application/json'
                            },
                            body: new URLSearchParams(new FormData(form))
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'üéâ Congratulations!',
                                    html: '<p>You have successfully purchased this item!</p><p>You will be redirected to your won items page.</p>',
                                    confirmButtonColor: '#198754',
                                    confirmButtonText: 'View My Won Items'
                                }).then(() => {
                                    window.location.href = data.redirectUrl || '/profile/wonitem';
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Purchase Failed',
                                    text: data.message || 'An error occurred while processing your purchase.',
                                    confirmButtonColor: '#dc3545',
                                    confirmButtonText: 'OK'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred. Please try again.',
                                confirmButtonColor: '#dc3545'
                            });
                        });
                    }
                });
            });
        }
        
    {{/if}}
</script>

<script>
    // View rating history functionality - Available for all users
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('view-ratings-btn') || e.target.closest('.view-ratings-btn')) {
            e.preventDefault();
            e.stopPropagation();
            
            const btn = e.target.closest('.view-ratings-btn') || e.target;
            const userId = btn.dataset.userId;
            const userName = btn.dataset.userName;
            
            if (!userId) return;
            
            // Show loading
            Swal.fire({
                title: 'Loading rating history...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Fetch rating data
            fetch(`/menu/user-ratings/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let ratingsHtml = '';
                        
                        if (data.ratings && data.ratings.length > 0) {
                            data.ratings.forEach(r => {
                                const initial = r.full_name ? r.full_name.charAt(0).toUpperCase() : 'U';
                                const badgeClass = r.rate === 1 ? 'badge-pos' : 'badge-neg';
                                const badgeIcon = r.rate === 1 ? '+1' : '-1';
                                const dateStr = new Date(r.created_at).toLocaleDateString('vi-VN');
                                
                                ratingsHtml += `
                                    <div class="rating-list-item">
                                        <div class="rating-avatar-small">${initial}</div>
                                        <div class="rating-content-small flex-grow-1">
                                            <div class="d-flex align-items-center gap-2 mb-1">
                                                <span class="fw-bold" style="font-size: 0.9rem;">${r.full_name || 'Unknown'}</span>
                                                <span class="text-muted" style="font-size: 0.75rem;">${dateStr}</span>
                                            </div>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">
                                                ${r.comment ? '"' + r.comment + '"' : '<em>No comment</em>'}
                                            </p>
                                        </div>
                                        <span class="rating-badge-small ${badgeClass}">${badgeIcon}</span>
                                    </div>
                                `;
                            });
                        } else {
                            ratingsHtml = `
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-chat-square-heart" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0">No ratings yet</p>
                                </div>
                            `;
                        }
                        
                        Swal.fire({
                            title: `<i class="bi bi-star-fill text-warning me-2"></i>${userName || 'User'}'s Ratings`,
                            html: `
                                <div class="rating-modal-stats">
                                    <div class="rating-modal-stat">
                                        <div class="stat-number">${data.totalRatings}</div>
                                        <div class="stat-label">Total</div>
                                    </div>
                                    <div class="rating-modal-stat positive">
                                        <div class="stat-number">${data.positiveCount}</div>
                                        <div class="stat-label">Positive</div>
                                    </div>
                                    <div class="rating-modal-stat negative">
                                        <div class="stat-number">${data.negativeCount}</div>
                                        <div class="stat-label">Negative</div>
                                    </div>
                                </div>
                                ${data.totalRatings > 0 ? `
                                    <div class="mb-3">
                                        <div class="progress" style="height: 10px; border-radius: 5px;">
                                            <div class="progress-bar bg-success" style="width: ${data.positivePercentage}%"></div>
                                        </div>
                                        <small class="text-muted mt-1 d-block">${data.positivePercentage}% positive feedback</small>
                                    </div>
                                ` : ''}
                                <div style="max-height: 350px; overflow-y: auto; text-align: left; padding: 5px;">
                                    ${ratingsHtml}
                                </div>
                            `,
                            width: 600,
                            showCloseButton: true,
                            showConfirmButton: false,
                            customClass: {
                                popup: 'rating-popup'
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'Failed to load rating history.',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while loading rating history.',
                        confirmButtonColor: '#dc3545'
                    });
                });
        }
    });
</script>

<script>
    $(document).ready(function () {

        // ==========================================
        // 1. OWL CAROUSEL (Related Products)
        // ==========================================
        $('.owl-carousel').owlCarousel({
            loop: true,           // Cho ph√©p cu·ªôn v√≤ng l·∫∑p
            margin: 20,           // Kho·∫£ng c√°ch gi·ªØa c√°c item
            nav: true,            // Hi·ªán m≈©i t√™n Next/Prev
            dots: false,          // ·∫®n d·∫•u ch·∫•m tr√≤n b√™n d∆∞·ªõi
            autoplay: true,       // T·ª± ƒë·ªông ch·∫°y
            autoplayTimeout: 3000,
            autoplayHoverPause: true,
            navText: [
                '<i class="bi bi-chevron-left"></i>',
                '<i class="bi bi-chevron-right"></i>'
            ],
            responsive: {
                0: { items: 1 },
                576: { items: 2 },
                768: { items: 3 },
                992: { items: 4 },
                1200: { items: 5 }
            }
        });

        // ==========================================
        // 2. CLEAVE JS (Format ti·ªÅn t·ªá)
        // ==========================================
        if ($('.currency-input').length) {
            $('.currency-input').toArray().forEach(function(field) {
                new Cleave(field, {
                    numeral: true,
                    numeralThousandsGroupStyle: 'thousand'
                });
            });
        }

        // ==========================================
        // 3. QUILL EDITOR (Cho Seller)
        // ==========================================
        if ($('#quill-editor').length) {
            var quill = new Quill('#quill-editor', {
                theme: 'snow',
                placeholder: 'Write your description update...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                    ]
                }
            });
            $('#frmAppendDesc').on('submit', function () {
                $('#hiddenDescInput').val(quill.root.innerHTML);
            });
        }

        // ==========================================
        // 4. LOGIC X·ª¨ L√ù ·∫¢NH (Gallery)
        // ==========================================
        const sellerId = '{{product.seller_id}}';
        const productId = '{{product.product_id}}';
        const basePath = `/src/static/images/${sellerId}/${productId}/`;
        
        // M·∫£ng t√™n file ·∫£nh (n·∫øu c·∫ßn fallback)
        const imageFiles = ['main.jpg', '1.jpg', '2.jpg', '3.jpg'];

        let currentIndex = 0;
        const totalImages = $('.thumb-img:visible').length; 
        let autoPlayTimer; 

        function updateGallery(index) {
            if (index < 0) index = totalImages - 1;
            if (index >= totalImages) index = 0;
            
            currentIndex = index;

            const $targetThumb = $(`.thumb-img[data-index="${currentIndex}"]`);
            const filename = $targetThumb.data('filename') || imageFiles[currentIndex];
            
            // --- HI·ªÜU ·ª®NG CHUY·ªÇN ·∫¢NH (FADE) ---
            // 1. D·ª´ng m·ªçi hi·ªáu ·ª©ng ƒëang ch·∫°y (stop)
            // 2. L√†m m·ªù ·∫£nh c≈© (fadeOut 200ms)
            // 3. ƒê·ªïi src
            // 4. Hi·ªán ·∫£nh m·ªõi (fadeIn 200ms)
            $('#mainImage').stop().fadeOut(200, function() {
                $(this).attr('src', basePath + filename).fadeIn(200);
            });

            // C·∫≠p nh·∫≠t active cho thumb
            $('.thumb-img').removeClass('active');
            $targetThumb.addClass('active');
        }

        // --- S·ª∞ KI·ªÜN CLICK THUMB ---
        // V·∫´n gi·ªØ nguy√™n ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m ch·ªçn ·∫£nh ƒë∆∞·ª£c
        $('.thumb-img').on('click', function () {
            updateGallery($(this).data('index'));
            resetTimer(); // Reset b·ªô ƒë·∫øm khi ng∆∞·ªùi d√πng can thi·ªáp
        });

        // --- T·ª∞ ƒê·ªòNG CH·∫†Y (AUTOPLAY) ---
        function startTimer() {
            autoPlayTimer = setInterval(function() {
                updateGallery(currentIndex + 1);
            }, 3000); // 3 gi√¢y chuy·ªÉn 1 l·∫ßn
        }

        function resetTimer() {
            clearInterval(autoPlayTimer);
            startTimer();
        }

        // B·∫Øt ƒë·∫ßu ch·∫°y
        startTimer();

        // Di chu·ªôt v√†o ·∫£nh -> D·ª´ng ch·∫°y
        $('.main-image-container').hover(
            function() { clearInterval(autoPlayTimer); }, 
            function() { startTimer(); }                  
        );
        // ==========================================
        // 5. LOGIC COMMENT & REPLY
        // ==========================================

        // S·ª± ki·ªán b·∫•m n√∫t Reply
        $(document).on('click', '.reply-trigger', function () {
            const commentId = $(this).data('id');
            $(`#reply-box-${commentId}`).toggleClass('d-none');
            $(`#reply-box-${commentId} input[name="content"]`).focus();
        });

        // X·ª≠ l√Ω Post Comment (Chung cho c·∫£ comment g·ªëc v√† reply)
        $(document).on('submit', '.frm-post-comment', async function (e) {
            e.preventDefault();

            const form = $(this);
            const productId = form.find('input[name="product_id"]').val();
            const parentId = form.find('input[name="parent_comment_id"]').val();
            const contentInput = form.find('input[name="content"]');
            const content = contentInput.val();

            if (!content.trim()) return;

            try {
                const response = await fetch('/menu/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: productId,
                        parent_comment_id: parentId,
                        content: content
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const newCmt = data.comment;
                    const firstLetter = newCmt.reviewer_name.charAt(0).toUpperCase();

                    // Logic v·∫Ω Badge Seller
                    const productSellerId = '{{product.seller_id}}';
                    let badgeHtml = '';
                    if (String(newCmt.user_id) === String(productSellerId)) {
                        badgeHtml = `<span class="badge bg-warning text-dark ms-2" style="font-size: 0.7rem;"><i class="bi bi-shop"></i> Seller</span>`;
                    }

                    const isReply = !!parentId;
                    const indentClass = isReply ? 'ms-5 mt-2' : 'mt-3';

                    const html = `
                    <div class="d-flex gap-2 animate__animated animate__fadeIn ${indentClass}">
                        <div class="flex-shrink-0">
                            <div class="avatar-badge bg-primary" style="width: ${isReply ? '32px' : '40px'}; height: ${isReply ? '32px' : '40px'}; font-size: ${isReply ? '0.8rem' : '1rem'};">
                                Me
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="comment-bubble">
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold" style="font-size: 0.9rem;">${newCmt.reviewer_name}</span>
                                    ${badgeHtml}
                                </div>
                                <div class="text-dark" style="font-size: 0.95rem;">${newCmt.content}</div>
                            </div>
                            <div class="ms-2 mt-1 d-flex gap-3 align-items-center">
                                <span class="text-muted small">Just now</span>
                            </div>
                        </div>
                    </div>`;

                    if (isReply) {
                        form.closest('.reply-box').after(html);
                        form.closest('.reply-box').addClass('d-none');
                    } else {
                        $('#commentList').append(html);
                        $('#no-feedback-msg').remove();
                    }
                    contentInput.val('');

                } else {
                    alert(data.message || 'Error posting comment');
                }
            } catch (err) {
                console.error(err);
                alert('Cannot connect to server');
            }
        });

        // ==========================================
        // 6. ADD TO WATCHLIST
        // ==========================================

        function updateAllWatchlistButtons(productId, isAdded) {
            // 1. C·∫≠p nh·∫≠t N√∫t To (Main Button) n·∫øu c√≥
            const mainBtn = $(`.wishlist-toggle[data-id="${productId}"]`);
            if (mainBtn.length) {
                if (isAdded) {
                    mainBtn.html('<i class="bi bi-heart-fill me-1"></i> Remove from watchlist');
                } else {
                    mainBtn.html('<i class="bi bi-heart me-1"></i> Add to watchlist');
                }
            }

            // 2. C·∫≠p nh·∫≠t N√∫t Tim Nh·ªè (Related Products) n·∫øu c√≥
            const smallBtns = $(`.wishlist-icon-small[data-id="${productId}"]`);
            smallBtns.each(function () {
                const icon = $(this).find('i');
                if (isAdded) {
                    icon.removeClass('bi-heart').addClass('bi-heart-fill text-gold');
                } else {
                    icon.removeClass('bi-heart-fill text-gold').addClass('bi-heart');
                }
            });
        }

        // H√†m g·ªçi AJAX
        function toggleWatchlist(productId) {
            $.post('/menu/watchlist/toggle', { product_id: productId }, function (data) {
                if (data.success) {
                    // G·ªçi h√†m c·∫≠p nh·∫≠t ƒë·ªìng b·ªô t·∫•t c·∫£ c√°c n√∫t
                    updateAllWatchlistButtons(productId, data.isAdded);
                } else {
                    alert(data.message);
                    if (data.message === 'Please login first!') {
                        window.location.href = '/signin';
                    }
                }
            }).fail(function () {
                alert('Cannot connect to server');
            });
        }

        // S·ª± ki·ªán cho n√∫t to (Main Button)
        $('.wishlist-toggle').on('click', function (e) {
            e.preventDefault();
            const id = $(this).data('id');
            toggleWatchlist(id);
        });

        // S·ª± ki·ªán cho n√∫t tim nh·ªè (Related Products)
        $('.wishlist-icon-small').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation(); // Ch·∫∑n s·ª± ki·ªán click lan ra card (tr√°nh nh·∫£y trang)
            const id = $(this).data('id');
            toggleWatchlist(id);
        });
    });
</script>
{{/section}}