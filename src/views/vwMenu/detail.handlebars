<!-- Breadcrumb -->
<div class="bg-white border-bottom">

</div>

<main class="container-fluid px-4 py-4">
    <!-- Back button -->
    <div class="mb-3">
        <button class="btn btn-light back-btn">
            <i class="bi bi-arrow-left"></i> Back
        </button>
    </div>

    <!-- Main product section -->
    <div class="row g-4">
        <!-- Left: big image + thumbnails -->
        <div class="col-lg-6">
            <div class="position-relative mb-3">
                <div class="product-main-img d-flex justify-content-center align-items-center">
                    Image
                </div>

                <!-- Image arrows -->
                <button class="btn btn-light rounded-circle position-absolute top-50 start-0 translate-middle-y ms-3">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-light rounded-circle position-absolute top-50 end-0 translate-middle-y me-3">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <!-- Color / image swatches -->
            <div class="d-flex gap-3">
                <div class="thumb-swatch"></div>
                <div class="thumb-swatch bg-dark"></div>
                <div class="thumb-swatch" style="background:#707780;"></div>
                <div class="thumb-swatch" style="background:#d2d6dd;"></div>
            </div>
        </div>

        <!-- Right: info -->
        <div class="col-lg-6">
            <div class="product-card h-100">
                <h3 class="mb-3">{{product.name}}</h3>

                <!-- Seller -->
                <div class="d-flex align-items-center mb-3">
                    <div class="badge-avatar badge-avatar-orange me-3">
                        S
                    </div>
                    <div>
                        <div class="fw-semibold">Seller: {{seller.seller_name}}</div>
                        <small class="text-muted">Points: {{seller.seller_point}}</small> 
                    </div>
                </div>

                {{#if (eq product.current_price null)}}
                <div class="mb-2 fw-semibold">
                        Starting bid: <span class="text-warning">{{formatCurrency product.start_price}}</span>
                </div>
                {{else}}
                <div class="mb-2 fw-semibold">
                        Current price: <span class="text-warning">{{formatCurrency product.current_price}}</span>
                </div>
                <!-- Highest bidder -->
                <div class="d-flex align-items-center mb-3">
                    <div class="badge-avatar badge-avatar-dark me-3">
                        B
                    </div>
                    <div>
                        <div class="fw-semibold">
                            {{#if winBidder.full_name}}
                                {{substr winBidder.full_name 0 1}}***
                            {{else}}
                                Anonymous
                            {{/if}}
                        </div>
                        <small class="text-muted">Points: {{winBidder.points}}</small>
                    </div>
                </div>
                {{/if}}
                <ul class="list-unstyled small text-muted mb-3">
                    <li>Start time: {{formatDate product.start_time 'DD/MM/YYYY HH:mm:ss'}}</li>
                    <li>Time left: {{formatDate product.end_time 'DD/MM/YYYY HH:mm:ss'}}</li>
                    <li>Bids: {{bidder.length}}</li>
                </ul>

                <div class="fw-semibold mb-3">
                    Buy it now: <span class="text-primary">$100</span>
                </div>

                <div class="d-flex gap-2">
                    
                    <button class="btn btn-outline-secondary px-4">
                        <i class="bi bi-heart"></i> Watch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bidding section (only show when logged in) -->
    {{#if isAuthenticated}}
    
    <section class="mt-5">
        <div class="row g-4">
            <!-- Bid Form -->
            {{#if (eq product.seller_id authUser.user_id)}}
            <div class="col-lg-6">
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>You cannot place a bid on your own product.</strong> 
                    </div>
                </div>
            </div>
            {{else}}

            <div class="col-lg-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Place Your Bid</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/menu/place-bid" id="bidForm">
                            <div class="mb-3">
                                <label for="bidAmount" class="form-label">Bid Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" 
                                           class="form-control" 
                                           id="bidAmount" 
                                           name="max_auto_bid" 
                                           placeholder="Enter your bid amount">

                                    <input type="hidden" name="product_id" value="{{product.product_id}}">
                                    <input type="hidden" name="bidder_id" value="{{authUser.user_id}}">
                                    <input type="hidden" id="minBid" value="{{product.start_price}}">
                                    
                                </div>
                            </div>
                            
                            {{#if (eq product.current_price null)}}
                                <div class="alert alert-info" role="alert">
                                    <strong>Minimum bid:</strong> {{formatCurrency product.start_price}}<br>
                                    <small class="text-muted">Bid step: {{formatCurrency product.bid_step}}</small>
                                </div>
                                
                            {{else}}
                                <div class="alert alert-info" role="alert">
                                    <strong>Current highest bid:</strong> {{formatCurrency product.current_price}}<br>
                                    <strong>Minimum next bid:</strong> {{formatCurrency suggestedPrice}}<br>
                                    <small class="text-muted">Bid step: {{formatCurrency product.bid_step}}</small>
                                    {{#if (eq authUser.user_id product.leader_id)}}
                                        <br><span class="badge bg-success">You are currently leading!</span>
                                    {{/if}}
                                </div>
                            {{/if}}

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary px-4" id="submitBidBtn">
                                    <i class="bi bi-hammer"></i> Submit Bid
                                </button>
                                <button type="reset" class="btn btn-outline-secondary px-4">
                                    Clear
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {{/if}}

            <!-- Bidding History -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> Bidding History
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        {{#if bidder}}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead>
                                        <tr class="table-light">
                                            <th>Time</th>
                                            <th>Bidder</th>
                                            <th class="text-end">Bid Amount</th>
                                            {{#if (eq authUser.user_id product.seller_id)}}
                                            <th class="text-center">Action</th>
                                            {{/if}}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each bidder}}
                                        <tr>
                                            <td>{{formatDate this.created_at 'DD/MM/YYYY HH:mm:ss'}}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="badge bg-secondary text-white rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                                        {{#if this.full_name}}
                                                            {{substr this.full_name 0 1}}
                                                        {{else}}
                                                            ?
                                                        {{/if}}
                                                    </div>
                                                    <div>
                                                        <span class="fw-semibold">
                                                            {{#if this.full_name}}
                                                                {{substr this.full_name 0 1}}***
                                                            {{else}}
                                                                Anonymous
                                                            {{/if}}
                                                        </span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <span class="badge {{#if @first}}bg-warning text-dark{{else}}bg-warning text-dark{{/if}}">{{formatCurrency this.bid_amount}}</span>
                                            </td>
                                            {{#if (eq ../authUser.user_id ../product.seller_id)}}
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-outline-danger reject-bidder-btn" 
                                                        data-bidder-id="{{this.user_id}}"
                                                        data-bidder-name="{{this.full_name}}"
                                                        data-product-id="{{../product.product_id}}">
                                                    <i class="bi bi-x-circle"></i> Reject
                                                </button>
                                            </td>
                                            {{/if}}
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        {{else}}
                            <p class="text-muted text-center py-4">
                                <i class="bi bi-inbox"></i><br>
                                No bids yet. Be the first to bid!
                            </p>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
    </section>

    {{else}}
    <section class="mt-5">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="bi bi-info-circle me-3" style="font-size: 1.5rem;"></i>
            <div>
                <strong>Want to place a bid?</strong> 
                <a href="/signin" class="alert-link">Sign in</a> or 
                <a href="/signup" class="alert-link">create an account</a> to start bidding!
            </div>
        </div>
    </section>
    {{/if}}

    <!-- Description section -->
    <section class="mt-5">
        <h5 class="mb-3">Description</h5>

        <div>{{{product.description_html}}}</div>
    </section>

    <!-- Feedback section -->
    <section class="mt-5">
        <h5 class="mb-3">Feedback</h5>
        {{#each comments}}
            <!-- Main comment -->
            <div class="section-box d-flex mb-2">
                <div class="me-3">
                    <div class="feedback-avatar {{#if (eq this.role 0)}}feedback-avatar-gray{{/if}}">
                        {{this.reviewer_initials}}
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold mb-1">{{this.reviewer_name}}</div>
                    <p class="small mb-0 text-muted">
                        {{this.content}}
                    </p>
                </div>
            </div> 

            <!-- Replies (nested comments) -->
            {{#each this.replies}}
            <div class="section-box d-flex mb-2 ms-5 border-start border-3 border-secondary ps-3">
                <div class="me-3">
                    <div class="feedback-avatar {{#if (eq this.role 1)}}feedback-avatar-gray{{/if}}">
                        {{this.reviewer_initials}}
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold mb-1">{{this.name}}</div>
                    <p class="small mb-0 text-muted">
                        {{this.content}}
                    </p>
                </div>
            </div>
            {{/each}}

            <div class="mb-3"></div>
        {{/each}}
    </section>

    <!-- Related products -->
    <section class="mt-5 mb-5">
        <h5 class="mb-3">Related products</h5>
        <div class="row g-3">
            <!-- Repeat this col for more products -->

            {{#each related_products}}
            <div class="col-6 col-md-4 col-lg-2">
                <div class="related-card">
                    <div class="related-img d-flex align-items-center justify-content-center">
                        Image
                    </div>

                    <button class="wishlist-btn">
                        <i class="bi bi-heart"></i>
                    </button>

                    <div class="p-2 small">
                        <div class="fw-semibold">{{this.name}}</div>
                        <div>Name of the bidder</div>
                        <div class="fw-semibold mb-1">$90</div>

                        <div class="text-muted">
                            <div>Buy it now: <span class="text-primary">$100</span></div>
                            <div>Listed: 02/11/2025</div>
                            <div>Time left: 11/11/2025</div>
                            <div>Bids: 9</div>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}

        </div>
    </section>
</main>

<!-- SweetAlert2 Library -->
{{#section 'js'}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.all.min.js"></script>

<script>
    // Bid form validation with SweetAlert
    {{#if isAuthenticated}}
        // Only attach bid form listener if form exists (user is not seller)
        const bidForm = document.getElementById('bidForm');
        if (bidForm) {
            bidForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                
                const bidAmount = parseFloat(document.getElementById('bidAmount').value);
                const minBid = parseFloat(document.getElementById('minBid').value);
                const highestBid = {{#if product.current_price}}{{product.current_price}}{{else}}{{product.start_price}}{{/if}};
                const maxBid = {{#if product.leader_max}}{{product.leader_max}}{{else}}0{{/if}};

                const authUserId = {{authUser.user_id}};
                const leaderId = {{#if product.leader_id}}{{product.leader_id}}{{else}}0{{/if}};
                
                // Basic client-side validation first
                if (!bidAmount || isNaN(bidAmount)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Bid',
                        text: 'Please enter a valid bid amount.',
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                if (bidAmount < minBid) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Bid Too Low',
                        text: `Minimum bid is $${minBid}. Please enter a bid of at least $${minBid}.`,
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Show loading state
                Swal.fire({
                    title: 'Processing your bid...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Send bid request to backend
                fetch('/menu/place-bid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(new FormData(form))
                })
                .then(response => {
                    if (response.ok) {
                        // Successful bid placement
                        Swal.fire({
                            icon: 'success',
                            title: 'Bid Placed Successfully!',
                            text: 'Your bid has been submitted successfully.',
                            confirmButtonColor: '#198754',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else if (response.status === 403) {
                        // Handle different types of 403 errors
                        return response.json().then(data => {
                            if (data.errorCode === 'NO_RATING_HISTORY') {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Rating Required',
                                    html: '<strong>This premium auction requires a rating history.</strong><br><br>To participate in this auction, you need to:<br>• Participate in other auctions first<br>• Receive ratings from sellers<br>• Build your reputation on the platform',
                                    confirmButtonColor: '#ffc107',
                                    confirmButtonText: 'Understood'
                                });
                            } else if (data.errorCode === 'INSUFFICIENT_RATING') {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Rating Too Low',
                                    html: `<strong>This premium auction requires at least 80% positive rating.</strong><br><br>Your current rating: <span class="text-danger">${data.currentRating.toFixed(1)}%</span><br>Required rating: <span class="text-success">80%</span><br><br>Continue participating in auctions and providing excellent service to improve your rating!`,
                                    confirmButtonColor: '#ffc107',
                                    confirmButtonText: 'Understood'
                                });
                            } else {
                                // Generic ban message
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Bidding Restricted',
                                    text: data.message || 'You have been restricted from bidding on this item by the seller.',
                                    confirmButtonColor: '#dc3545',
                                    confirmButtonText: 'OK'
                                });
                            }
                        });
                    } else {
                        // Other error
                        return response.text().then(text => {
                            throw new Error(text || 'Failed to place bid');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error placing bid:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'An error occurred while placing your bid. Please try again.',
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'OK'
                    });
                });
            });
        }
        
        // Reject bidder functionality for seller - Always attach this
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('reject-bidder-btn') || e.target.closest('.reject-bidder-btn')) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Reject button clicked!'); // Debug log
                
                const btn = e.target.closest('.reject-bidder-btn');
                const bidderId = btn.dataset.bidderId;
                const bidderName = btn.dataset.bidderName;
                const productId = btn.dataset.productId;
                
                console.log('Bidder ID:', bidderId, 'Product ID:', productId); // Debug log
                
                Swal.fire({
                    title: 'Reject Bidder?',
                    text: `Are you sure you want to reject ${bidderName ? bidderName.charAt(0) + '***' : 'this bidder'} from bidding on this item? This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, reject',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log('Sending reject request...'); // Debug log
                        
                        // Send reject request
                        fetch('/menu/reject-bidder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                bidder_id: bidderId,
                                product_id: productId
                            })
                        })
                        .then(response => {
                            console.log('Response status:', response.status); // Debug log
                            return response.json();
                        })
                        .then(data => {
                            console.log('Response data:', data); // Debug log
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Bidder Rejected',
                                    text: 'The bidder has been successfully rejected and notified via email.',
                                    confirmButtonColor: '#198754'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message || 'Failed to reject bidder.',
                                    confirmButtonColor: '#dc3545'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred. Please try again.',
                                confirmButtonColor: '#dc3545'
                            });
                        });
                    }
                });
            }
        });
        
    {{/if}}
</script>

{{/section}}