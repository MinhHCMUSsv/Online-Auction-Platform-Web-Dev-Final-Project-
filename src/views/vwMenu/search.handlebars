{{#section 'css'}}
<style>
    /* 1. Style cho khung Card */
    .product-card {
        transition: transform 0.2s;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Style cho sản phẩm mới */
    .product-card.product-new {
        border: 2px solid #FF8C00 !important;
        box-shadow: 0 0 10px rgba(255, 140, 0, 0.3);
    }

    .product-card.product-new:hover {
        box-shadow: 0 4px 20px rgba(255, 140, 0, 0.4);
    }

    .badge-new {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #FF8C00;
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        z-index: 10;
        animation: pulse-new 2s infinite;
    }

    @keyframes pulse-new {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* 2. Style cho ảnh */
    .product-image-placeholder {
        height: 220px;
        /* Chiều cao cố định cho khung ảnh */
        overflow: hidden;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-image-placeholder img {
        object-fit: contain;
        width: 100%;
        height: 100%;
    }

    /* 3. Style cho nút Tim */
    .text-gold {
        color: #ffc107 !important;
    }

    .wishlist-icon {
        z-index: 10;
        /* Đảm bảo nút tim nổi lên trên ảnh */
        cursor: pointer;
    }

    .wishlist-icon:hover {
        transform: scale(1.2);
        transition: 0.2s;
    }
</style>
{{/section}}

<div class="bg-white border-bottom">
    <div class="container-fluid px-4 py-3">

        <!-- Filter + Search -->
        <div class="d-flex align-items-center gap-3">

            <!-- Filter dropdown -->
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="bi bi-funnel"></i>
                    Filter
                </button>

                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/menu">All</a></li>

                    {{#each fatherCategories}}
                    <li>
                        <a class="dropdown-item" href="/menu/{{this.slug}}">
                            {{this.name}}
                        </a>
                    </li>
                    {{/each}}
                </ul>
            </div>

            <form class="flex-grow-1" action="/menu/search" method="GET">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search..." name="q">
                    <button class="btn btn-primary px-4" type="submit">
                        <i class="bi bi-search me-1"></i> Search
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- PRODUCT GRID -->
<div class="container-fluid px-4 py-4">
    <!-- Header with search and sort -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            {{#if empty}}
                No products found for "{{query}}"
            {{else}}
                Search results for "{{query}}" ({{products.length}} items)
            {{/if}}
        </h5>
        
        {{#unless empty}}
        <!-- Sort dropdown -->
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-arrow-up-down"></i>
              Sort
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item {{#unless sortBy}}active{{/unless}}" href="?q={{query}}">Default</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><h6 class="dropdown-header">By End Time</h6></li>
              <li><a class="dropdown-item {{#if (eq sortBy 'end_time_asc')}}active{{/if}}" href="?q={{query}}&sort=end_time_asc">End Time (Earliest First)</a></li>
              <li><a class="dropdown-item {{#if (eq sortBy 'end_time_desc')}}active{{/if}}" href="?q={{query}}&sort=end_time_desc">End Time (Latest First)</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><h6 class="dropdown-header">By Start Price</h6></li>
              <li><a class="dropdown-item {{#if (eq sortBy 'start_price_asc')}}active{{/if}}" href="?q={{query}}&sort=start_price_asc">Price (Low to High)</a></li>
              <li><a class="dropdown-item {{#if (eq sortBy 'start_price_desc')}}active{{/if}}" href="?q={{query}}&sort=start_price_desc">Price (High to Low)</a></li>
            </ul>
        </div>
        {{/unless}}
    </div>

{{#if empty}}
    <div class="text-center py-5">
        <i class="bi bi-search" style="font-size: 3rem; color: #ccc;"></i>
        <p class="mt-3 text-muted">No products found matching your search.</p>
        <a href="/menu" class="btn btn-primary">Browse All Products</a>
    </div>
{{else}}
    <div class="row g-3">
        {{#each products}}
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="product-card h-100 border rounded bg-white position-relative {{#if isNew}}product-new{{/if}}">
                {{#if isNew}}
                <span class="badge-new"><i class="bi bi-lightning-fill me-1"></i>New</span>
                {{/if}}

                <button
                    class="wishlist-icon border-0 position-absolute top-0 end-0 m-2 bg-transparent {{#if is_liked}}active{{/if}}"
                    data-id="{{this.product_id}}">
                    {{#if is_liked}}
                    <i class="bi bi-heart-fill text-gold fs-5"></i>
                    {{else}}
                    <i class="bi bi-heart fs-5 text-secondary"></i> {{/if}}
                </button>

                <div class="product-image-placeholder bg-light d-flex align-items-center justify-content-center text-muted"
                    style="height: 180px;">
                    <img src="/src/static/images/{{seller_id}}/{{product_id}}/main_thumbs.jpg" class="img-fluid">
                </div>

                <div class="product-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="product-title mb-1 text-truncate" title="{{this.name}}">
                            {{this.name}}
                        </h5>
                    </div>

                    <p class="mb-1 small">
                        <span class="fw-semibold">{{#if current_bidder_name}}Highest Bidder: {{maskName current_bidder_name}}{{else}}No
                            Bids{{/if}}</span><br>
                    </p>

                    <p class="product-meta mb-1 small text-muted">
                        <span class="fw-bold text-primary fs-5">
                            {{#if this.current_price}}
                            {{formatCurrency this.current_price}}
                            {{else}}
                            {{formatCurrency this.start_price}}
                            {{/if}}
                        </span>
                        <br>
                        <span>Buy it now: <span class="fw-bold text-primary">
                            {{#if this.buy_now_price}}
                            {{formatCurrency this.buy_now_price}}
                            {{else}}
                            None 
                            {{/if}}
                        </span>
                        </span><br>
                        <span>Listed: {{formatDate this.created_at "DD/MM/YYYY HH:mm"}}</span><br> <span>Time left:
                            {{formatAuctionTime this.end_time "DD/MM/YYYY HH:mm"}}</span><br>
                        <span>Bids: {{this.bid_count}}</span>
                    </p>

                    <div class="mt-2">
                        <a href="/menu/detail?product_id={{this.product_id}}"
                            class="btn btn-sm btn-outline-primary w-100">Details</a>
                    </div>
                </div>

            </div>
        </div>
        {{/each}}
        <nav aria-label="Search pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <span class="page-link">No pagination for search results</span>
                </li>
            </ul>
        </nav>
    </div>
</div>
{{/if}}

{{#section 'js'}}
<script>
    $('.wishlist-icon').on('click', function (e) {
        e.preventDefault();

        const $btn = $(this);
        const productId = $btn.data('id');
        const $icon = $btn.find('i');

        // Gửi AJAX request lên server
        $.post('/menu/watchlist/toggle', { product_id: productId }, function (data) {
            if (data.success) {
                if (data.isAdded) {
                    $btn.addClass('active');
                    $icon.removeClass('bi-heart text-secondary').addClass('bi-heart-fill text-gold');
                } else {
                    $btn.removeClass('active');
                    $icon.removeClass('bi-heart-fill text-gold').addClass('bi-heart text-secondary');
                }
            } else {
                alert(data.message || 'Something went wrong!');
                if (data.message === 'Please login first!') {
                    window.location.href = '/signin';
                }
            }
        }).fail(function (jqXHR, textStatus, errorThrown) {
            if (jqXHR.status === 401) {
                const msg = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'Please login first!';
                alert(msg);

                window.location.href = '/signin';
            } else {
                alert('Cannot connect to server!');
            }
        });
    });
</script>
{{/section}}