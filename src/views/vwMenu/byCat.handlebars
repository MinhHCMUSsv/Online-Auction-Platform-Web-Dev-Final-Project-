{{#section 'css'}}
<style>
  /* 1. Style cho khung Card */
  .product-card {
    transition: transform 0.2s;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* Style cho sản phẩm mới */
  .product-card.product-new {
    border: 2px solid #FF8C00 !important;
    box-shadow: 0 0 10px rgba(255, 140, 0, 0.3);
  }

  .product-card.product-new:hover {
    box-shadow: 0 4px 20px rgba(255, 140, 0, 0.4);
  }

  .badge-new {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #FF8C00;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    z-index: 10;
    animation: pulse-new 2s infinite;
  }

  @keyframes pulse-new {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* 2. Style cho ảnh */
  .product-image-placeholder {
    height: 220px;
    /* Chiều cao cố định cho khung ảnh */
    overflow: hidden;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-image-placeholder img {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }

  /* 3. Style cho nút Tim */
  .text-gold {
    color: #ffc107 !important;
  }

  .wishlist-icon {
    z-index: 10;
    /* Đảm bảo nút tim nổi lên trên ảnh */
    cursor: pointer;
  }

  .wishlist-icon:hover {
    transform: scale(1.2);
    transition: 0.2s;
  }

  /* 4. Style cho child categories */
  .child-category-item {
    transition: all 0.2s;
    text-decoration: none;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    padding: 8px 16px;
    margin: 4px;
    display: inline-block;
    background-color: #fff;
    color: #6c757d;
  }

  .child-category-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: #495057;
  }

  .child-category-item.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  .child-categories-container {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
    padding: 12px 0;
  }
</style>
{{/section}}

<div class="bg-white border-bottom">
  <div class="container-fluid px-4 py-3">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-3">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Menu</li>
      </ol>
    </nav>

    <!-- Filter + Search -->
    <div class="d-flex align-items-center gap-3">

      <!-- Parent Category Filter -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
          aria-expanded="false">
          <i class="bi bi-funnel"></i>
          {{#if currentParent}}
          {{currentParent.name}}
          {{else}}
          All Categories
          {{/if}}
        </button>

        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item {{#unless currentParent}}active{{/unless}}" href="/menu">All</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
          {{#each parentCategories}}
          <li>
            <a class="dropdown-item {{#if (eq this.slug ../parentSlug)}}active{{/if}}" href="/menu/{{this.slug}}">
              {{this.name}}
            </a>
          </li>
          {{/each}}
        </ul>
      </div>


      <form class="flex-grow-1" action="/menu/search" method="GET">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Search..." name="q">
          <button class="btn btn-primary px-4" type="submit">
            <i class="bi bi-search me-1"></i> Search
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- Child Categories Display (only show if parent is selected) -->
{{#if childCategories}}
<div class="child-categories-container">
  <div class="container-fluid px-4">
    <div class="d-flex flex-wrap align-items-center">
      <span class="me-3 fw-semibold text-muted">{{currentParent.name}}:</span>
      <a class="child-category-item {{#unless childSlug}}active{{/unless}}" href="/menu/{{parentSlug}}">
        All {{currentParent.name}}
      </a>
      {{#each childCategories}}
      <a class="child-category-item {{#if (eq this.slug ../childSlug)}}active{{/if}}"
        href="/menu/{{../parentSlug}}/{{this.slug}}">
        {{this.name}}
      </a>
      {{/each}}
    </div>
  </div>
</div>
{{/if}}

<!-- PRODUCT GRID -->
<div class="container-fluid px-4 py-4">
  <!-- Header with sort dropdown -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">
      {{#if childSlug}}
      {{#each childCategories}}{{#if (eq this.slug ../childSlug)}}Products in {{this.name}}{{/if}}{{/each}}
      {{else if currentParent}}
      Products in {{currentParent.name}}
      {{else}}
      All Products
      {{/if}}
    </h5>

    <!-- Sort dropdown -->
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
        aria-expanded="false">
        <i class="bi bi-arrow-up-down"></i>
        Sort
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        {{#if childSlug}}
        <li><a class="dropdown-item {{#unless sortBy}}active{{/unless}}"
            href="/menu/{{parentSlug}}/{{childSlug}}">Default</a></li>
        <li>
          <hr class="dropdown-divider">
        </li>
        <li>
          <h6 class="dropdown-header">By End Time</h6>
        </li>
        <li><a class="dropdown-item {{#if (eq sortBy 'end_time_asc')}}active{{/if}}"
            href="/menu/{{parentSlug}}/{{childSlug}}?sort=end_time_asc">End Time (Earliest First)</a></li>
        <li><a class="dropdown-item {{#if (eq sortBy 'end_time_desc')}}active{{/if}}"
            href="/menu/{{parentSlug}}/{{childSlug}}?sort=end_time_desc">End Time (Latest First)</a></li>
        <li>
          <hr class="dropdown-divider">
        </li>
        <li>
          <h6 class="dropdown-header">By Start Price</h6>
        </li>
        <li><a class="dropdown-item {{#if (eq sortBy 'start_price_asc')}}active{{/if}}"
            href="/menu/{{parentSlug}}/{{childSlug}}?sort=start_price_asc">Price (Low to High)</a></li>
        <li><a class="dropdown-item {{#if (eq sortBy 'start_price_desc')}}active{{/if}}"
            href="/menu/{{parentSlug}}/{{childSlug}}?sort=start_price_desc">Price (High to Low)</a></li>
        {{else}}
        <li><a class="dropdown-item {{#unless sortBy}}active{{/unless}}" href="/menu/{{parentSlug}}">Default</a></li>
        <li>
          <hr class="dropdown-divider">
        </li>
        <li>
          <h6 class="dropdown-header">By End Time</h6>
        </li>
        <li><a class="dropdown-item {{#if (eq sortBy 'end_time_asc')}}active{{/if}}"
            href="/menu/{{parentSlug}}?sort=end_time_asc">End Time (Earliest First)</a></li>
        <li><a class="dropdown-item {{#if (eq sortBy 'end_time_desc')}}active{{/if}}"
            href="/menu/{{parentSlug}}?sort=end_time_desc">End Time (Latest First)</a></li>
        <li>
          <hr class="dropdown-divider">
        </li>
        <li>
          <h6 class="dropdown-header">By Start Price</h6>
        </li>
        <li><a class="dropdown-item {{#if (eq sortBy 'start_price_asc')}}active{{/if}}"
            href="/menu/{{parentSlug}}?sort=start_price_asc">Price (Low to High)</a></li>
        <li><a class="dropdown-item {{#if (eq sortBy 'start_price_desc')}}active{{/if}}"
            href="/menu/{{parentSlug}}?sort=start_price_desc">Price (High to Low)</a></li>
        {{/if}}
      </ul>
    </div>
  </div>

  <div class="row g-3">
    {{#each products}}
    <div class="col-sm-6 col-md-4 col-lg-3">
      <div class="product-card h-100 border rounded bg-white position-relative {{#if isNew}}product-new{{/if}}">
        {{#if isNew}}
        <span class="badge-new"><i class="bi bi-lightning-fill me-1"></i>New</span>
        {{/if}}

        <button
          class="wishlist-icon border-0 position-absolute top-0 end-0 m-2 bg-transparent {{#if is_liked}}active{{/if}}"
          data-id="{{this.product_id}}">
          {{#if is_liked}}
          <i class="bi bi-heart-fill text-gold fs-5"></i>
          {{else}}
          <i class="bi bi-heart fs-5 text-secondary"></i> {{/if}}
        </button>

        <div class="product-image-placeholder bg-light d-flex align-items-center justify-content-center text-muted"
          style="height: 180px;">
          <img src="/src/static/images/{{seller_id}}/{{product_id}}/main_thumbs.jpg" class="img-fluid">
        </div>

        <div class="product-body p-3">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="product-title mb-1 text-truncate" title="{{this.name}}">
              {{this.name}}
            </h5>
          </div>

          <p class="mb-1 small">
            <span class="fw-semibold">{{#if current_bidder_name}}Highest Bidder: {{maskName current_bidder_name}}{{else}}No
              Bids{{/if}}</span><br>
          </p>

          <p class="product-meta mb-1 small text-muted">
            <span class="fw-bold text-primary fs-5">
              {{#if this.current_price}}
              ${{formatCurrency this.current_price}}
              {{else}}
              ${{formatCurrency this.start_price}}
              {{/if}}
            </span>
            <br>
            <span>Buy it now: <span class="fw-bold text-primary">{{#if this.buy_now_price}}${{formatCurrency
                this.buy_now_price}}
                {{else}}
                None {{/if}}</span></span><br>
            <span>Listed: {{formatDate this.created_at "DD/MM/YYYY HH:mm"}}</span><br> <span>Time left:
              {{formatAuctionTime
              this.end_time "DD/MM/YYYY HH:mm"}}</span><br>
            <span>Bids: {{this.bid_count}}</span>
          </p>

          <div class="mt-2">
            <a href="/menu/detail?product_id={{this.product_id}}" class="btn btn-sm btn-outline-primary w-100">Details</a>
          </div>
        </div>

      </div>
    </div>
    {{/each}}
    
    <nav aria-label="...">
      <ul class="pagination">
        {{#if prevPage}}
        <li class="page-item">
          {{#if childSlug}}
          <a class="page-link"
            href="/menu/{{parentSlug}}/{{childSlug}}?{{#if sortBy}}sort={{sortBy}}&{{/if}}page={{prevPage}}">Previous</a>
          {{else}}
          <a class="page-link"
            href="/menu/{{parentSlug}}?{{#if sortBy}}sort={{sortBy}}&{{/if}}page={{prevPage}}">Previous</a>
          {{/if}}
        </li>
        {{else}}
        <li class="page-item disabled">
          <a class="page-link">Previous</a>
        </li>
        {{/if}}
        {{#each pageNumbers}}
        {{#if isCurrent}}
        <li class="page-item active">
          <a class="page-link" href="javascript:;">{{value}}</a>
        </li>
        {{else}}
        <li class="page-item">
          {{#if ../childSlug}}
          <a class="page-link"
            href="/menu/{{../parentSlug}}/{{../childSlug}}?{{#if ../sortBy}}sort={{../sortBy}}&{{/if}}page={{value}}">{{value}}</a>
          {{else}}
          <a class="page-link"
            href="/menu/{{../parentSlug}}?{{#if ../sortBy}}sort={{../sortBy}}&{{/if}}page={{value}}">{{value}}</a>
          {{/if}}
        </li>
        {{/if}}
        {{/each}}
        {{#if nextPage}}
        <li class="page-item">
          {{#if childSlug}}
          <a class="page-link"
            href="/menu/{{parentSlug}}/{{childSlug}}?{{#if sortBy}}sort={{sortBy}}&{{/if}}page={{nextPage}}">Next</a>
          {{else}}
          <a class="page-link"
            href="/menu/{{parentSlug}}?{{#if sortBy}}sort={{sortBy}}&{{/if}}page={{nextPage}}">Next</a>
          {{/if}}
        </li>
        {{else}}
        <li class="page-item disabled">
          <a class="page-link">Next</a>
        </li>
        {{/if}}
      </ul>
    </nav>
  </div>
</div>

{{#section 'js'}}
<script>
  $('.wishlist-icon').on('click', function (e) {
    e.preventDefault();

    const $btn = $(this);
    const productId = $btn.data('id');
    const $icon = $btn.find('i');

    // Gửi AJAX request lên server
    $.post('/menu/watchlist/toggle', { product_id: productId }, function (data) {
      if (data.success) {
        if (data.isAdded) {
          $btn.addClass('active');
          $icon.removeClass('bi-heart text-secondary').addClass('bi-heart-fill text-gold');
        } else {
          $btn.removeClass('active');
          $icon.removeClass('bi-heart-fill text-gold').addClass('bi-heart text-secondary');
        }
      } else {
        alert(data.message || 'Something went wrong!');
        if (data.message === 'Please login first!') {
          window.location.href = '/signin';
        }
      }
    }).fail(function (jqXHR, textStatus, errorThrown) {
      if (jqXHR.status === 401) {
        const msg = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'Please login first!';
        alert(msg);

        window.location.href = '/signin';
      } else {
        alert('Cannot connect to server!');
      }
    });
  });
</script>
{{/section}}