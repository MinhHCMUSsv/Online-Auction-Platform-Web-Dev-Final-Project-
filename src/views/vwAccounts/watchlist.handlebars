{{#section 'js'}}
<script>
  $('.wishlist-icon').on('click', function (e) {
    e.preventDefault();
    const $btn = $(this);
    const productId = $btn.data('id');

    // Tìm cái thẻ cha chứa sản phẩm này (để xóa khỏi giao diện)
    const $cardColumn = $btn.closest('.watchlist-item');

    $.post('/menu/watchlist/toggle', { product_id: productId }, function (data) {
      if (data.success) {
        if (data.isAdded === false) {
          // Nếu kết quả trả về là đã XÓA (isAdded = false)
          // Ta xóa luôn cái card đó khỏi màn hình cho người dùng thấy hiệu ứng
          $cardColumn.fadeOut(300, function () {
            $(this).remove();

            // Kiểm tra nếu xóa hết thì hiện thông báo empty 
            if ($('.product-card').length === 0) {
              location.reload(); // Load lại để hiện thông báo "Empty"
            }
          });
        }
      } else {
        alert('Something went wrong');
      }
    }).fail(function () {
      alert('Cannot connect to server!');
    });
  });
</script>
{{/section}}

{{#section 'css'}}
<style>
  .product-card {
    transition: transform 0.2s;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* Style cho sản phẩm mới */
  .product-card.product-new {
    border: 2px solid #FF8C00 !important;
    box-shadow: 0 0 10px rgba(255, 140, 0, 0.3);
  }

  .product-card.product-new:hover {
    box-shadow: 0 4px 20px rgba(255, 140, 0, 0.4);
  }

  .badge-new {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #FF8C00;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    z-index: 10;
    animation: pulse-new 2s infinite;
  }

  @keyframes pulse-new {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Watch list icon*/
  .text-gold {
    color: #ffc107 !important;
  }

  .wishlist-icon:hover {
    transform: scale(1.2);
    transition: 0.2s;
  }

  .product-image-placeholder {
    height: 220px;
    /* Chiều cao cố định cho khung ảnh */
    overflow: hidden;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-image-placeholder img {
    object-fit: contain;
    width: 100%;
    height: 100%;
  }
</style>
{{/section}}


<h3 class="mb-4 fw-bold text-primary">Watchlist</h3>

{{#if watchlist.length}}
<div class="row g-3">
  {{#each watchlist}}
  <div class="col-sm-6 col-md-4 watchlist-item">
    <div class="product-card h-100 border rounded bg-white position-relative {{#if isNew}}product-new{{/if}}">
      {{#if isNew}}
      <span class="badge-new"><i class="bi bi-lightning-fill me-1"></i>New</span>
      {{/if}}

      <button class="wishlist-icon border-0 position-absolute top-0 end-0 m-2 bg-transparent active"
        data-id="{{this.product_id}}">
        <i class="bi bi-heart-fill text-gold fs-5"></i>
      </button>

      <div class="product-image-placeholder bg-light d-flex align-items-center justify-content-center text-muted"
        style="height: 180px;">
        <img src="/src/static/images/{{seller_id}}/{{product_id}}/main_thumbs.jpg" class="img-fluid">
      </div>

      <div class="product-body p-3">
        <div class="d-flex justify-content-between align-items-start">
          <h5 class="product-title mb-1 text-truncate" title="{{this.name}}">
            {{this.name}}
          </h5>
          <div class="product-price">
          </div>
        </div>

        <p class="mb-1 small">
          <span>{{#if this.current_bidder_name}}Highest Bidder: {{maskName this.current_bidder_name}}{{else}}No
            Bids{{/if}}</span><br>
        </p>

        <p class="product-meta mb-1 small text-muted">
          <span class="fw-bold text-primary fs-5">
            {{#if this.current_price}}
            ${{formatCurrency this.current_price}}
            {{else}}
            ${{formatCurrency this.start_price}}
            {{/if}}
          </span>
          <br>
          <span>Buy it now: <span class="fw-bold text-primary">{{#if this.buy_now_price}}${{formatCurrency
              this.buy_now_price}}
              {{else}} None {{/if}}</span></span><br>
          <span>Listed: {{formatDate this.created_at "DD/MM/YYYY HH:mm"}}</span><br>
          <span>Time left:
            {{formatAuctionTime
            this.end_time "DD/MM/YYYY HH:mm"}}</span><br>
          <span>Bids: {{this.bid_count}}</span>
        </p>

        <div class="mt-2">
          <a href="/menu/detail?product_id={{this.product_id}}" class="btn btn-sm btn-outline-primary w-100">Details</a>
        </div>
      </div>

    </div>
  </div>
  {{/each}}
</div>

<nav aria-label="Page navigation" class="mt-4">
  <ul class="pagination justify-content-center">
    {{#if prevPage}}
    <li class="page-item">
      <a class="page-link" href="?page={{prevPage}}">Previous</a>
    </li>
    {{else}}
    <li class="page-item disabled">
      <a class="page-link">Previous</a>
    </li>
    {{/if}}

    {{#each pageNumbers}}
    {{#if isCurrent}}
    <li class="page-item active"><a class="page-link" href="javascript:;">{{value}}</a></li>
    {{else}}
    <li class="page-item"><a class="page-link" href="?page={{value}}">{{value}}</a></li>
    {{/if}}
    {{/each}}

    {{#if nextPage}}
    <li class="page-item">
      <a class="page-link" href="?page={{nextPage}}">Next</a>
    </li>
    {{else}}
    <li class="page-item disabled">
      <a class="page-link">Next</a>
    </li>
    {{/if}}

  </ul>
</nav>

{{else}}
<div class="alert alert-info text-center">
  Your watchlist is currently empty. <a href="/menu" class="alert-link">Browse menu</a> to add some!
</div>
{{/if}}