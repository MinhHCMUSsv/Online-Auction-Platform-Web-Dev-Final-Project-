{{#section 'js'}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function () {
    // Xử lý chuyển đổi giữa Xem và Sửa
    $('#btnEdit').on('click', function () {
      $('#viewMode').addClass('d-none');
      $('#editMode').removeClass('d-none');
    });

    $('#btnCancel').on('click', function () {
      $('#editMode').addClass('d-none');
      $('#viewMode').removeClass('d-none');
      $('#passwordFields').addClass('d-none');
      $('#frmProfile').find('input[type="password"]').val('');
    });

    $('#btnTogglePass').on('click', function () {
      $('#passwordFields').toggleClass('d-none'); 
      if (!$('#passwordFields').hasClass('d-none')) {
        $('input[name="old_password"]').focus();
      }
    });

    const errMessage = '{{err_message}}';
    const successMessage = '{{success_message}}';

    if (errMessage) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: errMessage,
        confirmButtonColor: '#dc3545'
      });
    }

    if (successMessage) {
      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: successMessage,
        confirmButtonColor: '#0d6efd'
      });
    }

    $('#frmProfile').on('submit', function (e) {
      const isChangingPass = !$('#passwordFields').hasClass('d-none');

      if (isChangingPass) {
        const oldPass = $('input[name="old_password"]').val();
        const newPass = $('input[name="new_password"]').val();
        const confirmPass = $('input[name="confirm_new_password"]').val();

        if (!oldPass) {
          e.preventDefault();
          Swal.fire({
            icon: 'warning',
            text: 'Please enter your current password.'
          });
          return;
        }

        if (newPass || confirmPass) {
          if (newPass !== confirmPass) {
            e.preventDefault();
            Swal.fire({
              icon: 'warning',
              text: 'New password and confirm password do not match!'
            });
            return;
          }
          if (newPass.length < 6) {
            e.preventDefault();
            Swal.fire({
              icon: 'warning',
              text: 'Password must be at least 6 characters.'
            });
            return;
          }
        }
      }
    });
  });
</script>
{{/section}}

{{#section 'css'}}
<style>
  /* 1. Card chính: Bo tròn, bóng mờ, nền trắng */
  .settings-card {
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
    padding: 40px 50px;
    border: 1px solid rgba(0, 0, 0, 0.02);
  }

  /* 2. Dòng thông tin: Thêm đường kẻ phân cách */
  .settings-row {
    border-bottom: 1px solid #f1f1f1;
    padding: 20px 0;
    transition: background-color 0.2s;
    margin-bottom: 0 !important;
    /* Ghi đè mb-3 của bootstrap để dùng padding */
  }

  /* Bỏ đường kẻ ở dòng cuối cùng */
  .settings-row:last-child {
    border-bottom: none;
  }

  /* 3. Label (Nhãn): Chữ xám, nhỏ gọn, hiện đại */
  .info-label {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
  }

  /* 4. Value (Giá trị): Chữ đậm hơn, màu tối */
  .info-value {
    font-size: 1.1rem;
    font-weight: 500;
    color: #212529;
    display: flex;
    align-items: center;
  }

  /* 5. Input khi Edit: Bo tròn, nền xám nhẹ */
  .form-control {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px 15px;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .form-control:focus {
    background-color: #fff;
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
    border-color: #86b7fe;
  }

  /* 6. Nút Edit: Bo tròn kiểu viên thuốc */
  .btn-edit {
    background-color: var(--color-blue);
    color: white;
    font-weight: 600;
    padding: 10px 35px;
    border: none;
    border-radius: 50px;
    box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
    transition: all 0.3s ease;
  }

  .btn-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(13, 110, 253, 0.4);
    background-color: #0b5ed7;
    color: white;
  }

  /* 7. Dấu chấm mật khẩu */
  .password-dots {
    color: #adb5bd;
    font-size: 1.5rem;
    letter-spacing: 4px;
    line-height: 1;
    margin-top: 5px;
    /* Căn chỉnh lại cho khớp dòng */
  }

  /* Nút Cancel / Save trong form edit */
  .btn-action-cancel {
    border-radius: 50px;
    padding: 10px 25px;
  }

  .btn-action-save {
    border-radius: 50px;
    padding: 10px 30px;
  }
</style>
{{/section}}

{{#if showSettings}}
<div class="settings-card">

  <div id="viewMode">

    <div class="row settings-row">
      <div class="col-sm-3 info-label">Email</div>
      <div class="col-sm-9 info-value">{{user.email}}</div>
    </div>

    <div class="row settings-row">
      <div class="col-sm-3 info-label">Full name</div>
      <div class="col-sm-9 info-value">{{user.full_name}}</div>
    </div>

    <div class="row settings-row">
      <div class="col-sm-3 info-label">Address</div>
      <div class="col-sm-9 info-value">{{user.address}}</div>
    </div>

    <div class="row settings-row">
      <div class="col-sm-3 info-label">Date of Birth</div>
      <div class="col-sm-9 info-value">
        {{#if user.dob}}
        {{formatDate user.dob "DD/MM/YYYY"}}
        {{else}}
        <span class="text-muted fst-italic">Not updated yet</span>
        {{/if}}
      </div>
    </div>

    <div class="row settings-row">
      <div class="col-sm-3 info-label">Password</div>
      <div class="col-sm-9 info-value password-dots">•••••••••••••</div>
    </div>

    <div class="text-end mt-4">
      <button type="button" id="btnEdit" class="btn-edit">Edit Profile</button>
    </div>
  </div>

  <div id="editMode" class="d-none">

    <form action="/profile" method="POST" id="frmProfile">

      <div class="row settings-row">
        <div class="col-sm-3 info-label">Email</div>
        <div class="col-sm-9">
          <input type="email" class="form-control" name="email" value="{{user.email}}" readonly
            style="background-color: #e9ecef;">
        </div>
      </div>

      <div class="row settings-row">
        <div class="col-sm-3 info-label">Full name</div>
        <div class="col-sm-9">
          <input type="text" class="form-control" name="full_name" value="{{user.full_name}}" required>
        </div>
      </div>

      <div class="row settings-row">
        <div class="col-sm-3 info-label">Address</div>
        <div class="col-sm-9">
          <input type="text" class="form-control" name="address" value="{{user.address}}">
        </div>
      </div>

      <div class="row settings-row">
        <div class="col-sm-3 info-label">Date of Birth</div>
        <div class="col-sm-9">
          <input type="date" class="form-control" name="dob" value="{{formatDate user.dob 'YYYY-MM-DD'}}">
        </div>
      </div>

      <div class="mt-4 border-top pt-3">
        <div class="row settings-row border-0">
          <div class="col-sm-3 info-label">Password</div>
          <div class="col-sm-9">
            <button type="button" id="btnTogglePass" class="btn btn-outline-primary btn-sm rounded-pill fw-bold px-3">
              <i class="bi bi-key-fill me-1"></i> Change Password
            </button>
          </div>
        </div>

        <div id="passwordFields" class="d-none mt-3 p-4 bg-light rounded-3 border">
          <h6 class="fw-bold text-primary mb-3"><i class="bi bi-shield-lock"></i> Set New Password</h6>

          <div class="mb-3 row">
            <label class="col-sm-4 col-form-label text-muted small fw-bold">Current Password</label>
            <div class="col-sm-8">
              <input type="password" class="form-control" name="old_password" placeholder="Enter your current password" 
                     autocomplete="new-password" data-lpignore="true">
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-4 col-form-label text-muted small fw-bold">New Password</label>
            <div class="col-sm-8">
              <input type="password" class="form-control" name="new_password" placeholder="Enter new password"
                     autocomplete="new-password" data-lpignore="true">
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-4 col-form-label text-muted small fw-bold">Confirm Password</label>
            <div class="col-sm-8">
              <input type="password" class="form-control" name="confirm_new_password"
                placeholder="Confirm new password" autocomplete="new-password" data-lpignore="true">
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-4 pb-3 border-top pt-3">
        <button type="button" id="btnCancel" class="btn btn-secondary btn-action-cancel fw-bold">Cancel</button>
        <button type="submit" class="btn btn-success btn-action-save fw-bold">Save Changes</button>
      </div>

    </form>
  </div>

</div>
{{else}}
<div class="alert alert-warning text-center rounded-pill">Please select an item from the menu.</div>
{{/if}}